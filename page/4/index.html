<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>织网</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="织网">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="织网">
<meta property="og:locale">
<meta property="article:author" content="zheng-ji">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="织网" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">织网</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2018-07-01-boost-utility" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/01/2018-07-01-boost-utility/" class="article-date">
  <time datetime="2018-07-01T05:50:03.000Z" itemprop="datePublished">2018-07-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Program/">Program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/01/2018-07-01-boost-utility/">boost-utility</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>BOOST</code> 库的很多标准已经被纳入 C++11, 这也说明了 BOOST 库设计得到标准的重视。工作中需要用到 BOOST 的特性来加速开发。以下举例常用到的 utility</p>
<ul>
<li>BOOST_SCOPE_EXIT</li>
</ul>
<p>BOOST_SCOPE_EXIT（）里面可以传入多个参数, 其作用相当于回调函数， 在作用域结束之后程序会自动调用 BOOST_SCOPE_EXIT到BOOST_SCOPE_EXIT_END之间的代码。这个在异常捕捉，或者日志打印的时候会非常有用，节约代码。</p>
<p>举个例子</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span> <span class="params">(<span class="type">int</span> ans)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">bool</span> flag = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">BOOST_SCOPE_EXIT</span>(&amp;flag) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!flag)</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;false&quot;</span> &lt;&lt;std::endl;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;true&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125; BOOST_SCOPE_EXIT_END</span><br><span class="line">    flag = ((ans == <span class="number">1</span>)? <span class="literal">true</span>:<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>boost::split</li>
</ul>
<p>文本处理，切割字符串的利器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;boost/algorithm/string/split.hpp&gt;</span><br><span class="line">int main( int argc, char** argv )</span><br><span class="line">&#123;</span><br><span class="line">    string source = &quot;how to live in the world!&quot;;</span><br><span class="line">    vector&lt;string&gt; destination;</span><br><span class="line">    boost::split( destination, source, boost::is_any_of( &quot; ,!&quot; ), boost::token_compress_on );</span><br><span class="line">    vector&lt;string&gt;::iterator it ;</span><br><span class="line">    for (it= destination.begin(); it != destination.end(); ++ it)</span><br><span class="line">        cout &lt;&lt; *it &lt;&lt; endl;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>boost::regex</li>
</ul>
<p>正则匹配</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">boost::regex_match(str, boost::regex(&quot;^1[3|4|5|8][0-9]&#123;9&#125;$&quot;)) </span><br></pre></td></tr></table></figure>

<ul>
<li>BOOST 读写锁</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;boost/thread/shared_mutex.hpp&quot;</span><br><span class="line">boost::shared_mutex m_rwlock;</span><br><span class="line">boost::shared_lock&lt;boost::shared_mutex&gt; guard(m_rwlock);读锁</span><br><span class="line">boost::unique_lock&lt;boost::shared_mutex&gt; guard(m_rwlock);写锁</span><br><span class="line"></span><br><span class="line">#include &quot;boost/thread/locks.hpp&quot;</span><br><span class="line">#include &quot;boost/thread/shared_mutex.hpp&quot;</span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">//线程安全</span><br><span class="line">class NameMap&#123;</span><br><span class="line"></span><br><span class="line">    private:</span><br><span class="line">        boost::shared_mutex m_rwlock;</span><br><span class="line">        map&lt;uint32_t, string&gt; m_map;</span><br><span class="line">    public:</span><br><span class="line">        bool find(uint32_t uin, string &amp; nickname) &#123;</span><br><span class="line">            boost::shared_lock&lt;boost::shared_mutex&gt; guard(m_rwlock);</span><br><span class="line">            auto it = m_map.find(uin);</span><br><span class="line">            if(it == m_map.end())&#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;   </span><br><span class="line">            nickname = it-&gt;second;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        void insert(uint32_t uin, const string &amp; nickname) &#123;</span><br><span class="line">            boost::unique_lock&lt;boost::shared_mutex&gt; guard(m_rwlock);</span><br><span class="line">            m_map[uin]=nickname;</span><br><span class="line">        &#125;   </span><br><span class="line"></span><br><span class="line">        size_t size()&#123;</span><br><span class="line">            boost::shared_lock&lt;boost::shared_mutex&gt; guard(m_rwlock);</span><br><span class="line">            return m_map.size();</span><br><span class="line">        &#125;   </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/01/2018-07-01-boost-utility/" data-id="clnfj8m26005g30qxhdfr4g29" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2018-06-17-ban-nian-sui-xiang" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/17/2018-06-17-ban-nian-sui-xiang/" class="article-date">
  <time datetime="2018-06-17T07:49:00.000Z" itemprop="datePublished">2018-06-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Life/">Life</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/17/2018-06-17-ban-nian-sui-xiang/">半年随想</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>时光荏苒，这一次的博客更新，用了一年。 故事每天都在发生，不同时段的感悟也不尽相同。</p>
<p>过去四年接触的是小公司式的后端全栈工作。庆幸认识到人生中导师和伙伴。我从一个满腔热情,但啥都不懂的小毛孩, 到后面成长为独挡一面, 负责全公司的运维架构, 以及传承培育新人的老家伙。依然清晰记得每次凌晨无缝迁移服务器的喜悦, 以及将新技术运用到实践当中, 节约成本带来的精神富足。不得不说这是一个技术人最纯粹的感动。也有过战友离开的彷徨, 面对人事压力的焦虑。 点点滴滴占据了令人感动的回忆, 倏忽之间一晃而过。</p>
<p>新的征途几乎是一次完全的洗礼,进入微信, 从零开始接触 C++ 的后端开发, 以往熟悉的知识体系和经验都要翻开新的一页。开始硬磕指针和内存。</p>
<p>半年的开发时间</p>
<ul>
<li>写了一个通用的三机容灾布隆过滤器，支撑小程序的统计</li>
<li>改造几个组里的基础组件</li>
<li>承担搜索的排序模块</li>
<li>负载客服 IM 系统的设计与开发</li>
</ul>
<p>我也在慢慢接受和适应凶残的加班。 产品迭代速度快到有些窒息，这样的大背景下，我还在坚持记录文档的习惯，应该是微信的 “奇葩” 了, 我怕不靠谱的记忆力给自己，后人留坑。</p>
<p>生活的难题也一道道出现,想来也没什么好的解决方法,锻炼身心是我能把控当下的选择。偶尔我会在地铁读读古人的诗词,以前没觉得有什么, 如今觉得古人的诗词实在是豁达开朗。</p>
<p>说了挺多废话, 生活还在继续。相信认真生活的人运气不会太差, 愿我的朋友们也都有好运相伴。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/17/2018-06-17-ban-nian-sui-xiang/" data-id="clnfj8m26005e30qx0liw8g09" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017-07-13-httpserver-graceful-shutdown-in-go" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/13/2017-07-13-httpserver-graceful-shutdown-in-go/" class="article-date">
  <time datetime="2017-07-13T01:04:00.000Z" itemprop="datePublished">2017-07-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Program/">Program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/13/2017-07-13-httpserver-graceful-shutdown-in-go/">HTTPServer 优雅关闭</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>和同事聊到了服务在需要关闭的时候该如何优雅退出，顺藤摸瓜挖掘了Go1.8的特性。Go 1.8起新增了优雅退出 HTTPServer 的特性，也就是大家经常提到的 GraceFul ShutDown。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/net/http/server.go</span></span><br><span class="line"><span class="comment">// Shutdown gracefully shuts down the server without interrupting any active connections. Shutdown works by first closing all open listeners, then closing all idle connections, and then waiting indefinitely for connections to return to idle and then shut down. If the provided context expires before the shutdown is complete, then the context&#x27;s error is returned.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(srv *Server)</span></span> Shutdown(ctx context.Context) <span class="type">error</span> &#123;</span><br><span class="line">    atomic.AddInt32(&amp;srv.inShutdown, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">defer</span> atomic.AddInt32(&amp;srv.inShutdown, <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">    srv.mu.Lock()</span><br><span class="line">    lnerr := srv.closeListenersLocked()</span><br><span class="line">    srv.closeDoneChanLocked()</span><br><span class="line">    srv.mu.Unlock()</span><br><span class="line"></span><br><span class="line">    ticker := time.NewTicker(shutdownPollInterval)</span><br><span class="line">    <span class="keyword">defer</span> ticker.Stop()</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> srv.closeIdleConns() &#123;</span><br><span class="line">            <span class="keyword">return</span> lnerr</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            <span class="keyword">return</span> ctx.Err()</span><br><span class="line">        <span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>从文档注释得知，server.Shutdown 首先关闭所有 active 的 listener，以及所有处于 idle 状态的 Connections，然后无限等待那些处于 active 状态的 connection 变为 idle 状态后，关闭他们，Server退出。</p>
<p>如果有一个 Connection 依然处于 active 状态，那么 server 将一直 block 在那里。<br>Shutdown 接受一个 Context 参数，调用者可以通过 Context 传入一个等待的超时时间。<br>一旦超时，Shutdown 将直接返回。对于仍然处理 active 状态的Connection，就无能为力了。<br>所以 Shutdown 超时时间尽量要比链接处理的时间长。</p>
<p>了解完原理，我们用例子来感受一下这个特性。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;os/signal&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	router := gin.Default()</span><br><span class="line">	router.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		time.Sleep(<span class="number">3</span> * time.Second)</span><br><span class="line">		log.Printf(http.StatusOK, <span class="string">&quot;Handle request success&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	srv := &amp;http.Server&#123;</span><br><span class="line">		Addr:    <span class="string">&quot;:8080&quot;</span>,</span><br><span class="line">		Handler: router,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := srv.ListenAndServe(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;listen: %s\n&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	quit := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal)</span><br><span class="line">	signal.Notify(quit, os.Interrupt)</span><br><span class="line">	&lt;-quit</span><br><span class="line">	log.Println(<span class="string">&quot;Shutdown Server ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">	ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)</span><br><span class="line">	<span class="keyword">defer</span> cancel()</span><br><span class="line">	<span class="keyword">if</span> err := srv.Shutdown(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(<span class="string">&quot;Server Shutdown:&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="string">&quot;Server exist&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码中，每个请求都等待3秒才完成，使用信号来捕捉程序退出。退出时，HTTPServer 等待5秒来”善后”。我发起<code>curl localhost:8080</code>来测试，随即按下 Ctrl+C 退出程序，结果显示，服务器坚持在处理完这个 HTTP 请求才退出。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[GIN-debug] [WARNING] Running in &quot;debug&quot; mode. Switch to &quot;release&quot; mode in production.</span><br><span class="line"> - using env:	export GIN_MODE=release</span><br><span class="line"> - using code:	gin.SetMode(gin.ReleaseMode)</span><br><span class="line"></span><br><span class="line">[GIN-debug] GET    /                         --&gt; main.main.func1 (3 handlers)</span><br><span class="line">Handle Request success</span><br><span class="line">[GIN] 2017/07/12 - 20:30:47 | 200 |  3.000385597s | 127.0.0.1 |   GET     /</span><br><span class="line">^C  //终端输入Ctrl+C</span><br><span class="line">Shutdown Server ...</span><br><span class="line">listen: http: Server closed</span><br><span class="line">Handle Request success //在接收到关闭信号时，依然保证正在处理的请求正常处理完</span><br><span class="line">[GIN] 2017/07/12 - 20:30:53 | 200 |  3.000360362s | 127.0.0.1 |   GET     /</span><br><span class="line">Server exist</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/13/2017-07-13-httpserver-graceful-shutdown-in-go/" data-id="clnfj8m25005c30qxemjaf7ep" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017-06-04-mit-6-dot-824-mapreduce" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/04/2017-06-04-mit-6-dot-824-mapreduce/" class="article-date">
  <time datetime="2017-06-04T05:27:00.000Z" itemprop="datePublished">2017-06-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Program/">Program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/04/2017-06-04-mit-6-dot-824-mapreduce/">MIT 6.824 MapReduce</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>学习 MIT 6.824 <a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2017/labs/lab-1.html">Lab1 MapReduce</a>，做下笔记</p>
<h3 id="MapReduce-的思路"><a href="#MapReduce-的思路" class="headerlink" title="MapReduce 的思路"></a>MapReduce 的思路</h3><ul>
<li>把数据分成 M 份，每一份叫做 Mi</li>
<li>启动一个 master 对象，由它来控制如何分配调控</li>
<li>master 挑出一个 worker，对 Mi 执行 map 操作，返回一个 KV 数组</li>
<li>然后把 KV 数组分成 nReduce 份存在本地，等待 Reduce 操作。当 map 全部完成后，每个 Mi 产生 nReduce 份结果，每一个叫做 Ri。文件名：mrtmp-JobName-Mi-Ri 其中Mi Ri 分别表示数字，因此这一步会产生 M * nReduce 份文件。</li>
<li>从每个 Mi 中选择一份 Ri。然后根据 Key 排序，把相同 Key 的 Value 合在一起，生成 Key &#x2F;list(value)</li>
<li>开始 Reduce，输入list(value)，最后会生成 R 份文件 mrtmp.JobName-res-Ri</li>
<li>最后 Merge 成一个文件。</li>
</ul>
<h3 id="作业步骤"><a href="#作业步骤" class="headerlink" title="作业步骤"></a>作业步骤</h3><ul>
<li>Part1 完成 doMap 和 doReduce。doMap 完成3，4两个步骤. doReduce 完成5，6两个步骤。</li>
<li>Part2 实现 main&#x2F;wc.go 在Part1的基础上完成函数调用而已。</li>
<li>Part3 把 map 和 reduce 的操作变成异步。用到了RPC，用channel 来实现并发控制。</li>
</ul>
<h3 id="代码笔记"><a href="#代码笔记" class="headerlink" title="代码笔记"></a>代码笔记</h3><p><a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/blob/master/6.824-golabs-2017/src/mapreduce">源码</a></p>
<ul>
<li>common.go <a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/blob/master/6.824-golabs-2017/src/mapreduce/common.go#L11">11-32行</a>：可变参数打印日志，这个方法与C语言常用的类似</li>
<li>common_reduce.go <a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/blob/master/6.824-golabs-2017/src/mapreduce/common_reduce.go#L75">Line75</a>：sort.strings 对字符串切片排序</li>
<li>commo_rpc.go <a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/blob/master/6.824-golabs-2017/src/mapreduce/common_rpc.go#L59">Line59</a>：rpc调用方法</li>
<li>master.go <a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/blob/master/6.824-golabs-2017/src/mapreduce/master.go#L95">Line95-99</a>：当mr.newCond.Broadcast()被调用，此处就被唤醒，否则一直阻塞,mr.wait()所在的逻辑分支才会被唤醒，否则继续阻塞</li>
<li>master.go <a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/blob/master/6.824-golabs-2017/src/mapreduce/master.go#L15">Line15-16</a>：匿名参数，表示 Master 具有sync.Mutex的接口, 因而 Master 也能调用sync.Mutex的函数. 所以当调用 master.Lock()的时候也不足为奇</li>
<li>master_rpc.go <a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/blob/master/6.824-golabs-2017/src/mapreduce/master_rpc.go#L14">Line14</a>,<a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/blob/master/6.824-golabs-2017/src/mapreduce/master_rpc.go#L37">Line37</a>：chanel 被close的时候，case &lt;- shutdown 也就被触发了</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/06/04/2017-06-04-mit-6-dot-824-mapreduce/" data-id="clnfj8m25005a30qx0pqbg9z3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017-05-29-shuang-duan-lian-biao" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/29/2017-05-29-shuang-duan-lian-biao/" class="article-date">
  <time datetime="2017-05-29T15:19:00.000Z" itemprop="datePublished">2017-05-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Program/">Program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/29/2017-05-29-shuang-duan-lian-biao/">双端链表</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Nginx, Redis 项目中，均使用上了双链表。</p>
<ul>
<li><p>列表类型的键进行操作(RPUSH, LPOP)时，程序底层操作用的是双端链表。 <a target="_blank" rel="noopener" href="https://github.com/antirez/redis/blob/unstable/src/adlist.c">源码</a></p>
</li>
<li><p>Nginx 典型应用是在连接池中。Nginx 会处理大量的 socket 连接，为提高并发处理链接的能力，引入了连接池，其实现这个连接池用到了双链表。<a target="_blank" rel="noopener" href="https://github.com/nginx/nginx/blob/master/src/core/ngx_queue.c">源码</a>.</p>
</li>
</ul>
<p>对于双端链表，教科书上曾有提及，但如今映像并不深刻，再度理解并实践一次。</p>
<h3 id="结构定义与初始化"><a href="#结构定义与初始化" class="headerlink" title="结构定义与初始化"></a>结构定义与初始化</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> * <span class="title">next</span>;</span> <span class="comment">//前继指针</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> * <span class="title">pre</span>;</span>  <span class="comment">//后继指针</span></span><br><span class="line">&#125; Node;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dlist</span> &#123;</span></span><br><span class="line">    Node * head; <span class="comment">//双链表的指向头结点的元素</span></span><br><span class="line">    Node * tail; <span class="comment">//双链表指向尾部节点的元素，方便从后检索</span></span><br><span class="line">&#125; dlist;</span><br></pre></td></tr></table></figure>

<p>初始化的双链表，<code>head</code>,<code>tail</code> 均为空。</p>
<h3 id="插入操作"><a href="#插入操作" class="headerlink" title="插入操作"></a>插入操作</h3><p>插入操作，是按照递增的顺序插入，涉及到双链表的更改，因此传参是指向链表的指针，分三种情况</p>
<ul>
<li>空链表插入头元素，head 与 tail 节点均要修改</li>
<li>在链表尾部插入节点，要变动 tail 指针</li>
<li>中间插入节点</li>
</ul>
<img src="/images/2017/05/dlist-insert.png" class="">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">insertDlist</span><span class="params">(dlist **<span class="built_in">list</span>, <span class="type">int</span> num)</span> &#123;</span><br><span class="line">    Node * head = (*<span class="built_in">list</span>) -&gt; head;</span><br><span class="line">    Node * tail = (*<span class="built_in">list</span>) -&gt; tail;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">list</span> == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    Node * node = initNode(num);</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// empty dlist</span></span><br><span class="line">    <span class="keyword">if</span> ((*<span class="built_in">list</span>) -&gt; head == <span class="literal">NULL</span> &amp;&amp; (*<span class="built_in">list</span>) -&gt; tail == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        (*<span class="built_in">list</span>)-&gt; head = node;</span><br><span class="line">        (*<span class="built_in">list</span>)-&gt; tail = node;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (head -&gt; next &amp;&amp; head -&gt; num &lt; num) &#123;</span><br><span class="line">        head = head -&gt; next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// at the end</span></span><br><span class="line">    <span class="keyword">if</span> (head-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        head -&gt; next = node;</span><br><span class="line">        node -&gt; pre = head;</span><br><span class="line">        tail -&gt; pre = node;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// in the middle</span></span><br><span class="line">        node-&gt; next = head -&gt; next;</span><br><span class="line">        head -&gt; next -&gt; pre = node;</span><br><span class="line">        node -&gt; pre = head;</span><br><span class="line">        head -&gt; next = node;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="删除操作"><a href="#删除操作" class="headerlink" title="删除操作"></a>删除操作</h3><p>删除操作，要涉及到双链表的更改，因此传参是指向链表的指针，分三种情况</p>
<ul>
<li>删除头结点，</li>
<li>删除尾节点</li>
<li>删除中间节点</li>
</ul>
<img src="/images/2017/05/dlist-delete.png" class="">

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">deleteDlist</span><span class="params">(dlist ** <span class="built_in">list</span>, <span class="type">int</span> location)</span> &#123;</span><br><span class="line">    Node * head = (*<span class="built_in">list</span>) -&gt; head;</span><br><span class="line">    Node * now = <span class="literal">NULL</span>;</span><br><span class="line">    Node * last = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (head == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (location &lt;= <span class="number">0</span> || location &gt; numOfDlist(*<span class="built_in">list</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (location == <span class="number">1</span>) &#123;</span><br><span class="line">        now = head;</span><br><span class="line">        (*<span class="built_in">list</span>) -&gt; head = now -&gt;next;</span><br><span class="line">        head -&gt; next -&gt;pre = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (now) &#123;</span><br><span class="line">            <span class="built_in">free</span>(now);</span><br><span class="line">            now = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (head &amp;&amp; num++ &lt; location) &#123;</span><br><span class="line">        head = head -&gt; next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (head -&gt; next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        now = (*<span class="built_in">list</span>) -&gt; tail;</span><br><span class="line">        head -&gt; pre -&gt; next = <span class="literal">NULL</span>;</span><br><span class="line">        now -&gt; pre = head-&gt;pre;</span><br><span class="line">        <span class="keyword">if</span> (head) &#123;</span><br><span class="line">            <span class="built_in">free</span>(head);</span><br><span class="line">            head = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        now = head -&gt; next;</span><br><span class="line">        last = head -&gt; pre;</span><br><span class="line">        now -&gt;pre = head -&gt; pre;</span><br><span class="line">        last -&gt; next = head -&gt;next;</span><br><span class="line">        <span class="keyword">if</span> (head) &#123;</span><br><span class="line">            <span class="built_in">free</span>(head);</span><br><span class="line">            head = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本文所述是 C 语言实现的，<a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/blob/master/Dlist/mydlist.c">源码</a><br>在 Go 语言之中, <code>container/list</code> 包实现了双链表，直接引入就可以使用了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/05/29/2017-05-29-shuang-duan-lian-biao/" data-id="clnfj8m24005830qxe9xe7xil" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017-02-25-zookeeper-bi-ji" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/25/2017-02-25-zookeeper-bi-ji/" class="article-date">
  <time datetime="2017-02-25T09:30:00.000Z" itemprop="datePublished">2017-02-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Server/">Server</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/25/2017-02-25-zookeeper-bi-ji/">zookeeper 笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>ZooKeeper 是一个开源的分布式协调服务，是分布式数据一致性的解决方案。</p>
<h3 id="集群角色"><a href="#集群角色" class="headerlink" title="集群角色"></a>集群角色</h3><p>在 ZooKeeper 中，有三种角色： Leader，Follower，Observer</p>
<p>一个 ZooKeeper 集群同时只会有一个Leader，其他都是 Follower 或 Observer。<br>Leader 服务器为客户端提供读和写服务，Follower 和 Observer 都能提供读服务，不能提供写服务。区别在于，Observer 不参与 Leader 选举过程，也不参与写操作的过半写成功策略，因此 Observer 可以在不影响写性能的情况下提升集群的读性能。</p>
<h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><p>客户端和 ZooKeeper 服务器会与服务器建立一个 TCP 连接，通过这个连接，客户端能够通过心跳检测和服务器保持有效的会话，也能够向 ZooKeeper 服务器发送请求并接受响应，同时还能通过该连接接收来自服务器的 Watch 事件通知。</p>
<h3 id="数据节点"><a href="#数据节点" class="headerlink" title="数据节点"></a>数据节点</h3><p>ZooKeeper 中的数据节点是指数据模型中的数据单元，称为 ZNode。ZooKeeper将所有数据存储在内存中，数据模型是一棵树（ZNode Tree），由斜杠进行分割的路径，就是一个ZNode。每个ZNode上都会保存自己的数据内容，同时会保存一系列属性信息。每个ZNode不仅本身可以写数据，还可以有下一级文件或目录。</p>
<p>在ZooKeeper中，ZNode可以分为持久节点和临时节点两类。持久节点是指一旦这个 ZNode 被创建了，除非主动进行 ZNode 的移除操作，否则这个 ZNode 将一直保存在 ZooKeeper上。临时节点的生命周期跟客户端会话绑定，一旦客户端会话失效，那么这个客户端创建的所有临时节点都会被移除。</p>
<p>ZooKeeper 允许用户为每个节点添加一个特殊的属性：SEQUENTIAL。一旦节点被标记上这个属性，那么在这个节点被创建的时候，ZooKeeper就会自动在其节点后面追加上一个整型数字，这个整型数字是一个由父节点维护的自增数字。</p>
<h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><p>ZooKeeper 的每个 ZNode 上都会存储数据，对于每个ZNode，ZooKeeper都会为其维护一个叫作Stat的数据结构，Stat中记录了这个ZNode的三个数据版本，分别是 version（当前ZNode的版本, cversion（当前ZNode子节点的版本）和 aversion（当前ZNode的ACL版本）。</p>
<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><p>在 ZooKeeper 中，能改变 ZooKeeper 服务器状态的操作称为事务操作。包括数据节点创建与删除、数据内容更新和客户端会话创建与失效等操作。对应每一个事务请求，ZooKeeper都会为其分配一个全局唯一的事务ID，用ZXID表示，通常是一个64位的数字。每一个ZXID对应一次更新操作，从这些ZXID中可以间接地识别出ZooKeeper处理这些事务操作请求的全局顺序。</p>
<h3 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h3><p>ZooKeeper 允许用户在指定节点上注册一些 Watcher，并且在一些特定事件触发的时候，ZooKeeper 服务端会将事件通知到感兴趣的客户端上去。该机制是 ZooKeeper 实现分布式协调服务的重要特性。</p>
<h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><p>ZooKeeper 采用 Access Control Lists 策略来进行权限控制。ZooKeeper 定义了如下5种权限。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE: 创建子节点的权限。</span><br><span class="line">READ: 获取节点数据和子节点列表的权限。</span><br><span class="line">WRITE：更新节点数据的权限。</span><br><span class="line">DELETE: 删除子节点的权限。</span><br><span class="line">ADMIN: 设置节点ACL的权限。</span><br><span class="line">注意：CREATE 和 DELETE 都是针对子节点的权限控制。</span><br></pre></td></tr></table></figure>

<h3 id="ZAB-原子广播协议"><a href="#ZAB-原子广播协议" class="headerlink" title="ZAB 原子广播协议"></a>ZAB 原子广播协议</h3><p>ZooKeeper Atomic Broadcast（ZAB，ZooKeeper原子广播协议）的协议作为其数据一致性的核心算法。</p>
<p>所有事务请求必须由一个全局唯一的服务器来协调处理，这样的服务器被称为Leader服务器，而剩下的其他服务器则成为 Follower 服务器。Leader 服务器负责将一个客户端事务请求转换成一个事务 Proposal（提案）并将该 Proposal分发给集群中所有的 Follower 服务器。之后 Leader 服务器需要等待所有 Follower 服务器的反馈，一旦超过半数的 Follower 服务器进行了正确的反馈后，Leader 就会再次向所有的 Follower 服务器分发 Commit 消息，要求对刚才的 Proposal 进行提交。</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li>数据发布与订阅-配置中心</li>
</ul>
<p>发布者将数据发布到 ZooKeeper 节点上，供订阅者进行数据订阅，进而达到动态获取数据的目的，实现配置信息的集中式管理和动态更新。全局配置信息就可以发布到 ZooKeeper 上，让客户端（集群的机器）去订阅该消息。</p>
<p>客户端想服务端注册自己需要关注的节点，一旦该节点的数据发生变更，那么服务端就会向相应的客户端发送 Watcher 事件通知，客户端接收到这个消息通知后，需要主动到服务端获取最新的数据（推拉结合）。</p>
<ul>
<li><p>命名服务，即生成全局唯一的ID。</p>
</li>
<li><p>分布式协调通知</p>
</li>
</ul>
<p>ZooKeeper 中特有 Watcher 注册与异步通知机制，实现对数据变更的实时处理。不同的客户端都对ZK上同一个ZNode 进行注册，监听 ZNode 的变化（包括ZNode本身内容及子节点的），如果 ZNode 发生了变化，那么所有订阅的客户端都能够接收到相应的 Watcher 通知，并做出相应的处理，是一种通用的分布式系统机器间的通信方式。</p>
<ul>
<li>心跳检测</li>
</ul>
<p>基于 ZK 临时节点的特性，可以让不同的进程都在 ZK 的一个指定节点下创建临时子节点，不同的进程直接可以根据这个临时子节点来判断对应的进程是否存活。通过这种方式，检测和被检测系统直接并不需要直接相关联，而是通过 ZK 上的某个节点进行关联，大大减少了系统耦合。</p>
<ul>
<li>分布式锁</li>
</ul>
<p>分布式锁是控制分布式系统之间同步访问共享资源的一种方式。分布式锁又分为排他锁和共享锁两种。 排他锁又称为写锁或独占锁，共享锁又称为读锁。</p>
<p>把 ZooKeeper 上一个 ZNode 看作是一个锁，获得锁就通过创建ZNode的方式来实现。所有客户端都去&#x2F;x_lock节点下创建临时子节点&#x2F;x_lock&#x2F;lock。ZooKeeper会保证在所有客户端中，最终只有一个客户端能够创建成功，那么就可以认为该客户端获得了锁。同时，所有没有获取到锁的客户端就需要到&#x2F;x_lock节点上注册一个子节点变更的 Watcher 监听，以便实时监听到 lock 节点的变更情况。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/02/25/2017-02-25-zookeeper-bi-ji/" data-id="clnfj8m24005630qxh1ujdfuu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2017-02-22-zheng-xiang-yu-fan-xiang-dai-li" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/22/2017-02-22-zheng-xiang-yu-fan-xiang-dai-li/" class="article-date">
  <time datetime="2017-02-22T14:30:00.000Z" itemprop="datePublished">2017-02-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/System/">System</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/22/2017-02-22-zheng-xiang-yu-fan-xiang-dai-li/">Squid 做正向代理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="正向代理和反向代理"><a href="#正向代理和反向代理" class="headerlink" title="正向代理和反向代理"></a>正向代理和反向代理</h3><ul>
<li>正向代理</li>
</ul>
<p>正向代理 是一个位于客户端和原始服务器之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定原始服务器，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。</p>
<ul>
<li>反向代理</li>
</ul>
<p>反向代理正好相反，对于客户端而言它就像是原始服务器，并且客户端不需要进行任何特别的设置。客户端向反向代理内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端，就像这些内容原本就是它自己的一样。</p>
<h3 id="正向代理软件"><a href="#正向代理软件" class="headerlink" title="正向代理软件"></a>正向代理软件</h3><p>Nginx 能做正向代理，遗憾的是它不能做 HTTPS 的正向代理。以下是一个例子。</p>
<ul>
<li>不能有 hostname。 </li>
<li>必须有 resolver, 即 DNS</li>
<li>配置正向代理参数，均是由 Nginx 变量组成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">      resolver 8.8.8.8;</span><br><span class="line">      resolver_timeout 30s; </span><br><span class="line">      listen 80;</span><br><span class="line">      location / &#123;</span><br><span class="line">                proxy_pass http://$http_host$request_uri;</span><br><span class="line">                proxy_set_header Host $http_host;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Squid 可正向代理 HTTP 以及 HTTPS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install squid</span><br></pre></td></tr></table></figure>

<p>编辑 <code>/etc/squid3/squid.conf</code>, 并重启</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http_port 3128                 	#代理服务器的端口</span><br><span class="line">#http_access deny !Safe_ports 	#注释掉此项</span><br><span class="line">#http_access deny manager     	#注释掉此项</span><br><span class="line"></span><br><span class="line">#添加下面两项，设置哪些网段可以访问本代理服务器</span><br><span class="line">acl our_networks src 172.16.1.0/24 </span><br><span class="line">http_access allow our_networks</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service squid3 restart</span><br></pre></td></tr></table></figure>

<p>Squid 的层次代理值得一提， 若我们需要定期地切换代理服务器的话, 启动一个 Squid 代理, 而这个代理会将请求转发到其他代理上面. 然后我们只需定时更新本地 Squid 代理的配置文件, 然后重启这个本地代理即可. 层次代理用到了 <code>cache_peer</code> 这个配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cache_peer hostname type http_port icp_port option</span><br><span class="line"></span><br><span class="line">e.g.</span><br><span class="line">cache_peer xxx.proxy.com parent 9020 0 no-query default login=xxxxx:yyyy</span><br></pre></td></tr></table></figure>

<ul>
<li>hostname: 指被请求的同级子代理服务器或父代理服务器。可以用主机名或ip地址表示；</li>
<li>type：指明 hostname 的类型，是同级子代理服务器还是父代理服务器，也即 parent 还是 sibling；</li>
<li>http_port：hostname的监听端口；</li>
<li>icp_port：hostname 上的ICP监听端口，对于不支持ICP协议的可指定7；</li>
<li>options：可以包含一个或多个关键字。<ol>
<li>proxy-only：指明从peer得到的数据在本地不进行缓存，缺省地，squid是要缓存这部分数据的；</li>
<li>weight&#x3D;n：用于有多个peer的情况，如果多于一个以上的peer拥有你请求的数据时，squid通过计算每个peer ICP 响应时间来 决定其weight的值，然后 squid 向其中拥有最大 weight 的peer发出ICP请求。</li>
<li>no-query：不向该peer发送ICP请求。如果该peer不可用时，可以使用该选项；</li>
<li>Default：有点象路由表中的缺省路由，该peer将被用作最后的尝试手段。当你只有一个父代理服务器并且其不支持ICP协议时，可以使用default和no-query选项让所有请求都发送到该父代理服务器；</li>
</ol>
</li>
<li>login&#x3D;user:password：当你的父代理服务器要求用户认证时可以使用该选项来进行认证</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/02/22/2017-02-22-zheng-xiang-yu-fan-xiang-dai-li/" data-id="clnfj8m23005430qx64cub3np" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-12-02-cgroupxian-zhi-ji-suan-zi-yuan" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/02/2016-12-02-cgroupxian-zhi-ji-suan-zi-yuan/" class="article-date">
  <time datetime="2016-12-02T07:41:00.000Z" itemprop="datePublished">2016-12-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/System/">System</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/02/2016-12-02-cgroupxian-zhi-ji-suan-zi-yuan/">cgroup 限制计算资源</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Cgroup 实现了对计算机资源使用上的隔离，它是 Docker 底层的基础技术。我们可以用它来限制程序使用的CPU、内存、磁盘。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>在 Ubuntu 14.04 下安装的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install cgroup-bin</span><br></pre></td></tr></table></figure>

<p>安装完后执行<br><code>mount -t cgroup</code> 会出现如下，可以看到它其实是一个文件系统</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,relatime,cpuset)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpu type cgroup (rw,relatime,cpu)</span><br><span class="line">...</span><br><span class="line">cgroup on /sys/fs/cgroup/hugetlb type cgroup (rw,relatime,hugetlb)</span><br></pre></td></tr></table></figure>

<p>如果没有看到以上的目录，这时候需要手动 mount 了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /sys/fs</span><br><span class="line">mkdir cgroup</span><br><span class="line">mount -t tmpfs cgroup_root ./cgroup</span><br><span class="line">mkdir cgroup/cpuset</span><br><span class="line">mount -t cgroup -ocpuset cpuset ./cgroup/cpuset/</span><br><span class="line">mkdir cgroup/cpu</span><br><span class="line">mount -t cgroup -ocpu cpu ./cgroup/cpu/</span><br><span class="line">mkdir cgroup/memory</span><br><span class="line">mount -t cgroup -omemory memory ./cgroup/memory/</span><br></pre></td></tr></table></figure>

<h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><p>我们来感性认识下 cgroup 吧，编写一个耗费 CPU 的程序，姑且叫暴走程序(baozou)</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    count = count + <span class="number">1</span> - <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>运行该程序，top -p 之，100% CPU使用率</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  PID      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                       </span><br><span class="line">16515      20   0    2336    728    544 R  100.0  0.0   1:27.23 baozou</span><br></pre></td></tr></table></figure>

<p>我想限制暴走程序 CPU 使用该如何做? 我们手动创建一个 cgroup 目录来针对它。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /sys/fs/cgroup/cpu</span><br><span class="line"><span class="built_in">mkdir</span> calm      // 名字可自定义</span><br><span class="line"><span class="built_in">ls</span> /calm        // 该目录下自动生产与 CPU 有关的文件</span><br><span class="line">cgroup.clone_children  cpu.cfs_period_us  cpu.shares  notify_on_release</span><br><span class="line">cgroup.procs           cpu.cfs_quota_us   cpu.stat    tasks</span><br></pre></td></tr></table></figure>

<p>接着写入限制规则</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 默认是100000，20000意味着限制它的cpu为20%</span><br><span class="line">echo 20000 &gt; /sys/fs/cgroup/cpu/calm/cpu.cfs_quota_us, </span><br><span class="line"></span><br><span class="line">// 写入程序的 PID 16515</span><br><span class="line">echo 16515 &gt; /sys/fs/cgroup/cpu/calm/tasks</span><br></pre></td></tr></table></figure>

<p>于是 CPU 就降到 20% 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  PID       PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                       </span><br><span class="line">16515       20   0    2336    728    544 R  20.0  0.0   1:27.23 baozou</span><br></pre></td></tr></table></figure>

<p>除了这种需要指定 PID 来限制资源的方法，也可通过指定规则来执行，更显得方便，效果和上述一致。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cgexec -g cpu:calm ./baozou</span><br></pre></td></tr></table></figure>

<p>可以看看这个限制规则做了什么?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cgget calm</span><br><span class="line">calm:</span><br><span class="line">cpu.shares: 1024</span><br><span class="line">cpu.cfs_quota_us: 20000</span><br><span class="line">cpu.stat: nr_periods 6943</span><br><span class="line">    nr_throttled 6941</span><br><span class="line">    throttled_time 563080015831</span><br><span class="line">cpu.cfs_period_us: 100000</span><br></pre></td></tr></table></figure>

<p>上述的例子中，我们手动创建了 <code>calm</code>， 其实也能通过命令来做到的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 创建cgroup 文件目录</span><br><span class="line">sudo cgcreate -g cpu:/calm -g memory:/calm</span><br><span class="line"></span><br><span class="line">// 设置限制的参数</span><br><span class="line">sudo cgset -r cpu.shares=200 calm</span><br><span class="line"></span><br><span class="line">// 限制了内存</span><br><span class="line">sudo cgset -r memory.limit_in_bytes=64k calm</span><br><span class="line"></span><br><span class="line">// 可以删除</span><br><span class="line">sudo cgdelete cpu/calm memory:/calm</span><br></pre></td></tr></table></figure>

<hr>
<p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://coolshell.cn/articles/17049.html">Docker基础技术: Linux CGroup</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/dc3140699e79">cgroup实践</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/02/2016-12-02-cgroupxian-zhi-ji-suan-zi-yuan/" data-id="clnfj8m23005130qxbz3oabfv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-09-28-ji-yi-ci-redis-server-bug" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/28/2016-09-28-ji-yi-ci-redis-server-bug/" class="article-date">
  <time datetime="2016-09-28T00:21:00.000Z" itemprop="datePublished">2016-09-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Redis/">Redis</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/28/2016-09-28-ji-yi-ci-redis-server-bug/">记一次使用 redis 协议诡异的bug</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>记录昨天定位一个诡异 bug 的过程，我耗费了不少精力，你若有兴趣，请带着一点耐心看完它。</p>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E8%8A%82">问题背景</a></li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E8%8A%82">重新问题 </a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E8%8A%82">试着解决问题</a></li>
<li><a href="#%E7%AC%AC%E5%9B%9B%E8%8A%82">一点总结</a></li>
</ul>
<h3 id="第一节">问题背景</h3>

<p>我们使用 <a target="_blank" rel="noopener" href="https://github.com/youmi/go-redis-server">go-redis-server</a> 开发具有 redis 协议的服务。 按照文档，我们实现了如下接口，其背后访问的是 AWS 的 Dynamodb，我们的服务也开发了监控接口，以供我们这些程序狗知道它发生了什么。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *RedisHandler)</span></span> Get(key <span class="type">string</span>) (result <span class="type">string</span>, err <span class="type">error</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *RedisHandler)</span></span> Set(key <span class="type">string</span>, val <span class="type">string</span>) (err <span class="type">error</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *RedisHandler)</span></span> Del(key <span class="type">string</span>) (count <span class="type">int</span>, err <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<p>这样，我们就能通过 redis 客户端来执行 Get，Set，Del 操作。</p>
<p>我在批量写入几千条数据时，通过监控接口，我看到服务突然卡住的样子，没有 Get，Set的统计信息了。但我能肯定的是客户端一直有数据在往服务写入，或者读写。<br>同时从 AWS 监控得到的反馈是 Dynamodb 使用超过预设值，我调高了读写预设值，重启服务，就恢复可用（重启大法好）。<br>程序试运行十多天，只发生过一次异常，之后再无重现。<br>这个事情没有搞清楚，就成为我一个心结。</p>
<h3 id="第二节">重现问题</h3>

<p>我们来看看代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *RedisHandler)</span></span> </span><br><span class="line">Set(key <span class="type">string</span>, val <span class="type">string</span>) (err <span class="type">error</span>) &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	m, err := JSONToMap(val)</span><br><span class="line">	_, err = table.PutItem(m)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Log.Errorf(<span class="string">&quot;PutItem failed, </span></span><br><span class="line"><span class="string">		table: %s, primary key: %s, value: %+v, </span></span><br><span class="line"><span class="string">		err: %s&quot;</span>, </span><br><span class="line">		tableName, primaryVal, m, err.Error())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Set接口，简单的将数据写入 Dynamodb，Dynamodb 如果异常就返回错误，然后通过redis协议返回给客户端。</p>
<p>我很大程度确定那时候是因为 AWS Dynamodb 的异常导致这个错误的。除非这个巧合太牛逼了，难道 go-redis-server 接口不支持返回错误不成吗？这个猜想很快就被我们用实验否定了。</p>
<p>我想重新触发 AWS Dynamodb 返回写容量超标的错误，测试了一阵子，并不容易重现。有点沮丧，这个时候我回忆起 aws-go-sdk 的特点，如果给Dynamodb 字段 赋予空值，是会有异常返回的，<br>类似如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ValidationException: One or more parameter values were invalid:</span><br><span class="line">An AttributeValue may not contain an empty string</span><br><span class="line">	status code: 400</span><br></pre></td></tr></table></figure>

<p>空值的测试明显容易制造。我在本地也开启服务，端口是1234，用 pyredis 作为客户端做测试。<br>测试脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">r = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>,port=<span class="number">1234</span>,db=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">table_name = <span class="string">&#x27;test&#x27;</span></span><br><span class="line">primary_key = <span class="string">&#x27;a&#x27;</span></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">if</span> i &gt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;a&#x27;</span>: <span class="built_in">str</span>(random.random()),</span><br><span class="line">        <span class="string">&#x27;b&#x27;</span>: ‘’,</span><br><span class="line">    &#125;</span><br><span class="line">    key = <span class="string">&#x27;&#123;0&#125;:&#123;1&#125;:&#123;2&#125;&#x27;</span>.<span class="built_in">format</span>(table_name, primary_key, data[primary_key])</span><br><span class="line">    value = json.dumps(data)</span><br><span class="line">    r.<span class="built_in">set</span>(key, value)</span><br><span class="line">    i = i + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>发现测试程序卡在终端，一动不动，strace 测试程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo strace -p 22404</span><br><span class="line">Process 22404 attached</span><br><span class="line">recvfrom(3,</span><br></pre></td></tr></table></figure>

<p>感觉像是在等待服务器返回，但是等不到回报的样子。</p>
<h3 id="第三节">试着解决问题</h3>

<p>难道 go-redis-server 这个框架有猫腻，我就开始了一下午的看源码之旅。不得不说源码写的真好。回头看我们出错的代码片段，我试着修改 err 信息，修改成自己定义的错误字符串。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *RedisHandler)</span></span> Set(key <span class="type">string</span>, val <span class="type">string</span>) (err <span class="type">error</span>) &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	m, err := JSONToMap(val)</span><br><span class="line">	_, err = table.PutItem(m)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		err = errors.New(<span class="string">&quot;I am a Custom Error&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次执行测试脚本，这一次。2条测试数据很快就执行结束，并无阻塞。<br>好像看到了一丝曙光：error 内容的不一样，导致不一样的结果。类型一样，那么我能怀疑的就是格式，或者长度了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">AWS 错误信息的格式：</span><br><span class="line">ValidationException: One or more parameter values were invalid:</span><br><span class="line">An AttributeValue may not contain an empty string</span><br><span class="line">	status code: 400</span><br><span class="line"></span><br><span class="line">我自定义错误信息的格式：</span><br><span class="line">I am a Custom Error</span><br></pre></td></tr></table></figure>

<p>我特意加长了自定义错误的长度，结果也是能顺利执行不阻塞客户端。但是我给自定义错误字符串加入了换行符，果然客户端再次测试会出现阻塞。当出现错误的时候，源码中是调用了 ErrorReply.WriteTo 这个函数，特别的。返回错误的协议格式是</p>
<blockquote>
<p>第一个字节将是“-”,并以CR + LF 结尾</p>
</blockquote>
<p>配合源码，以下是 go-redis-server 最核心的逻辑调度代码。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">	request, err := parseRequest(conn)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">		request.Host = clientAddr</span><br><span class="line">		request.ClientChan = clientChan</span><br><span class="line">		reply, err := srv.Apply(request)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> _, err = reply.WriteTo(conn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(er *ErrorReply)</span></span> WriteTo(w io.Writer) (<span class="type">int64</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	n, err := w.Write([]<span class="type">byte</span>(<span class="string">&quot;-&quot;</span> + er.code + <span class="string">&quot; &quot;</span> + er.message + <span class="string">&quot;\r\n&quot;</span>))</span><br><span class="line">	<span class="keyword">return</span> <span class="type">int64</span>(n), err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从 <a target="_blank" rel="noopener" href="http://redis.cn/topics/protocol.html">Redis协议官方文档</a>，可以确定客户端与服务器端之间传输的每个 Redis 命令或者数据都以 <code>\r\n</code> 结尾。 我们的错误信息中间杀出了 <code>\n</code>，导致协议错乱，redis 客户端不能理解协议，就阻塞了。</p>
<h3 id="第四节">一点总结</h3>

<ul>
<li><p>以后我们使用 go-redis-server 的服务时候，要记得检查返回的字符串或者错误信息有没有包含换行符，如果有，最好做一次过滤替换。</p>
</li>
<li><p>出现这个bug,我和同事都觉得不可思议，非常神奇。在没有其他直观线索的条件下，阅读使用的库的源码，并在源码加上一些输出验证语言加以辅助，收到了效果，的确需要一些耐心。但我觉得是值得的。</p>
</li>
<li><p>李笑来说有效阅读就是精度，这次阅读代码过程中我还有意外的收获，我发现了 reflect 的妙用，以及函数注册在框架可以那么用，读完觉得很满足的样子，值得再记录一番。</p>
</li>
</ul>
<hr>
<p>附链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://redis.cn/topics/protocol.html">Redis官方协议</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/youmi/go-redis-server">go-redis-server</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/09/28/2016-09-28-ji-yi-ci-redis-server-bug/" data-id="clnfj8m23004z30qx5y2kdg8v" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-09-25-gong-xiang-nei-cun-yu-xin-hao-liang" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/25/2016-09-25-gong-xiang-nei-cun-yu-xin-hao-liang/" class="article-date">
  <time datetime="2016-09-25T15:37:00.000Z" itemprop="datePublished">2016-09-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/System/">System</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/25/2016-09-25-gong-xiang-nei-cun-yu-xin-hao-liang/">共享内存与信号量</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天和朋友聊天，他多次提到了共享内存，惭愧的是我没怎么用上，只是从 APUE 等神书阅读到此类名词。这个周末，我来搞懂它们。</p>
<h3 id="共享内存"><a href="#共享内存" class="headerlink" title="共享内存"></a>共享内存</h3><p>它是 Linux 最底层的通信机制，被称为最快的通信机制。多个进程共享同一个内存区域实现进程间通信。一个进程创建一个共享内存区域，并将数据存放到共享内存中，而后多个进程对其进行访问。</p>
<p>借鉴网友的例子，我做了注释和修改，一个进程写共享内存 (shmwrite.c)，一个进程读共享内存(shmread.c)。</p>
<p>共享内存并未提供同步机制，在第一个进程结束对共享内存的写操作之前，并无自动机制阻止第二个进程开始对它进行读取。上述代码中，我通过自己维护了一个变量 isWritten 来控制同步行为。</p>
<p>还好，伟大的计算机先驱们提供了信号量来帮我们解决同步的问题。</p>
<h3 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h3><p>为了防止出现因多个程序同时访问一个共享资源带来的问题，Linux 使用 信号量协调进程对共享资源的访问的。<br>信号量只能进行两种操作等待和发送信号，即 P(sv) 和 V(sv).</p>
<ul>
<li>P(sv)：当sv的值大于零，就减1；当它的值为零，就挂起该进程的执行。</li>
<li>V(sv)：当有其他进程因等待sv而被挂起，就让它恢复运行，当没有进程因等待sv而挂起，就给它加1.</li>
</ul>
<p>比如：两个进程共享信号量 sv，其中一个进程执行了 P(sv) 操作，它将得到信号量，进入临界区，将 sv 减1。此时sv&#x3D;0,第二个进程将被阻止进入临界区，它会被挂起以等待第一个进程离开临界区域,并执行 V(sv) 释放信号量，这时第二个进程就可以恢复执行。</p>
<h3 id="mmap-还是-shmget"><a href="#mmap-还是-shmget" class="headerlink" title="mmap 还是 shmget"></a>mmap 还是 shmget</h3><p>这两个东西某种程度上很类似。</p>
<p>内存映射，将用户空间的一段内存区域映射到内核空间,用户对这段内存区域的修改可以直接反映到内核空间，同样，内核空间对这段区域的修改也直接反映用户空间。两者之间需要大量数据传输等操作的话效率是非常高的.</p>
<p>mmap 并不是完全为了用于共享内存而设计的。它提供了不同于一般对普通文件的访问方式，进程可以像读写内存一样对普通文件的操作。而 Posix 或系统V的共享内存 IPC 则纯粹用于共享目的.</p>
<p>mmap 使得进程之间通过映射同一个普通文件实现共享内存。普通文件被映射到进程地址空间后，进程可以像访问普通内存一样对文件进行访问，不必再调用 read()，write() 等操作。mmap 并不分配空间, 只是将文件映射到调用进程的地址空间里 然后你就可以用 memcpy 等操作写文件。</p>
<hr>
<p>附上代码：</p>
<ul>
<li>共享数据结构: <a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/blob/master/shared_memory/shmdata.h">shmdata.h</a></li>
<li>读共享内存：<a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/blob/master/shared_memory/shmread.c">shmread.c</a></li>
<li>写共享内存：<a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/blob/master/shared_memory/shmwrite.c">shmwrite.c</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/09/25/2016-09-25-gong-xiang-nei-cun-yu-xin-hao-liang/" data-id="clnfj8m22004x30qxavi14m6u" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/5/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/DataBase/">DataBase</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ElasticSearch/">ElasticSearch</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Life/">Life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/NLP/">NLP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/NetWork/">NetWork</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Product/">Product</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Program/">Program</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Server/">Server</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/">System</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/grpc/">grpc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/k8s/">k8s</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mq/">mq</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithm/" rel="tag">Algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-11/" rel="tag">C++11</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DataBase/" rel="tag">DataBase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/" rel="tag">Go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LRU/" rel="tag">LRU</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ProtoBuffer/" rel="tag">ProtoBuffer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/System/" rel="tag">System</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/groupCache/" rel="tag">groupCache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grpc/" rel="tag">grpc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s-basic/" rel="tag">k8s basic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx-grpc/" rel="tag">nginx grpc</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Algorithm/" style="font-size: 10px;">Algorithm</a> <a href="/tags/C-11/" style="font-size: 10px;">C++11</a> <a href="/tags/DataBase/" style="font-size: 10px;">DataBase</a> <a href="/tags/Go/" style="font-size: 10px;">Go</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/LRU/" style="font-size: 10px;">LRU</a> <a href="/tags/MQ/" style="font-size: 10px;">MQ</a> <a href="/tags/ProtoBuffer/" style="font-size: 10px;">ProtoBuffer</a> <a href="/tags/Redis/" style="font-size: 16.67px;">Redis</a> <a href="/tags/System/" style="font-size: 10px;">System</a> <a href="/tags/groupCache/" style="font-size: 10px;">groupCache</a> <a href="/tags/grpc/" style="font-size: 13.33px;">grpc</a> <a href="/tags/k8s/" style="font-size: 20px;">k8s</a> <a href="/tags/k8s-basic/" style="font-size: 10px;">k8s basic</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nginx-grpc/" style="font-size: 10px;">nginx grpc</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">May 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">May 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03/">March 2012</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/20/2021-10-20-why-docker-supervisor/"> Docker里使用 supervisor 管理多个程序</a>
          </li>
        
          <li>
            <a href="/2021/10/14/2021-10-14-binary-tree-algo/">二叉树相关的递归算法题</a>
          </li>
        
          <li>
            <a href="/2021/10/13/2021-10-13-go-channel/">Go Channel 笔记</a>
          </li>
        
          <li>
            <a href="/2021/10/12/2021-10-12-why-kafka-so-fast/">Kafka 吞吐量大的原因</a>
          </li>
        
          <li>
            <a href="/2021/10/11/2021-10-11-redis-pipeline/">Redis Pipline 与事务</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 zheng-ji<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>