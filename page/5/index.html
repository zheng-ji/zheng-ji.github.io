<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>织网</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="织网">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="织网">
<meta property="og:locale">
<meta property="article:author" content="zheng-ji">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="织网" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">织网</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2016-08-01-cuckoofilter" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/01/2016-08-01-cuckoofilter/" class="article-date">
  <time datetime="2016-08-01T11:48:00.000Z" itemprop="datePublished">2016-08-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Program/">Program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/01/2016-08-01-cuckoofilter/">CuckooFilter，BloomFilter的优化</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>面对海量数据，我们需要一个索引数据结构，用来帮助查询，快速判断数据记录是否存在，这类数据结构叫过滤器，常用的选择是 <code>Bloom Filter</code>. 而 <code>Cuckoo Filter</code> 是它的优化变种。借此也用 Golang 实践了这个<a target="_blank" rel="noopener" href="https://github.com/zheng-ji/goCuckoo">算法</a>。</p>
<p><img src="https://cloud.githubusercontent.com/assets/1414745/17084380/8c3a4896-51ee-11e6-869e-b087226cc5ce.jpg" alt="goCuckoo"></p>
<p><code>Bloom Filter</code> 的位图模式有两个问题：</p>
<ul>
<li>误报，它能判断元素一定不存在，但只能判断可能存在，因为存在其它元素被映射到部分相同位上，导致该位置1，那么一个不存在的元素可能会被误报成存在；</li>
<li>漏报，如果删除了某个元素，导致该映射位被置0，那么本来存在的元素会被漏报成不存在。</li>
</ul>
<p><code>Cuckoo Filter</code>，可以确保该元素存在的必然性，又可以在不违背此前提下删除任意元素，仅仅比 <code>Bloom Filter</code> 牺牲了微量空间效率。 它的的数据模型: </p>
<ul>
<li>每个元素对应两个哈希算法，在哈希碰撞时会启用备用哈希算法。</li>
<li>每一个桶是有4路的，每个槽对应一个指纹。</li>
</ul>
<p><img src="https://cloud.githubusercontent.com/assets/1414745/17103421/c97635e0-52b0-11e6-83ac-1b1fdbb5d31c.png" alt="model"></p>
<h2 id="Feature"><a href="#Feature" class="headerlink" title="Feature"></a>Feature</h2><ul>
<li>支持删除操作</li>
<li>支持快速查找，支持 O(1) 查找速度</li>
<li>高效的空间利用，四路槽的表，可以有95% 的空间利用率</li>
<li>可替代布隆过滤器</li>
</ul>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/zheng-ji/goCuckoo</span><br></pre></td></tr></table></figure>

<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/zheng-ji/goCuckoo&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// speicify capacity </span></span><br><span class="line">	filter := cuckoo.NewCuckooFilter(<span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">	filter.Insert([]<span class="type">byte</span>(<span class="string">&quot;zheng-ji&quot;</span>))</span><br><span class="line">	filter.Insert([]<span class="type">byte</span>(<span class="string">&quot;stupid&quot;</span>))</span><br><span class="line">	filter.Insert([]<span class="type">byte</span>(<span class="string">&quot;coder&quot;</span>))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> filter.Find([]<span class="type">byte</span>(<span class="string">&quot;stupid&quot;</span>)) &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;exist&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Not exist&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	filter.Del([]<span class="type">byte</span>(<span class="string">&quot;stupid&quot;</span>))</span><br><span class="line">	filter.Println(filter.Size())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.cs.cmu.edu/~binfan/papers/conext14_cuckoofilter.pdf">CMU Paper</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cs.cmu.edu/~binfan/papers/conext14_cuckoofilter.pptx">CMU PPT</a></li>
<li><a target="_blank" rel="noopener" href="http://coolshell.cn/articles/17225.html">CoolShell Article</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/08/01/2016-08-01-cuckoofilter/" data-id="clnfj8m22004v30qx9xdch82v" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-07-23-celeryde-crontabshi-jian" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/23/2016-07-23-celeryde-crontabshi-jian/" class="article-date">
  <time datetime="2016-07-23T12:19:00.000Z" itemprop="datePublished">2016-07-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Program/">Program</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/23/2016-07-23-celeryde-crontabshi-jian/">Celery的Crontab实践</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>有时候我们需要处理耗时的操作，同时又要保持较快的响应速度，就需要借助异步队列的帮助。Celery 作为异步队列服务，想必是很多人和我一样的选择。用法在官方文档也详细介绍，不再赘述。</p>
<p>这次想记录的是用 Celery 来实现定时任务。这里也有一点点坑。</p>
<p>以下是 <code>main.py</code> 的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"><span class="keyword">from</span> lib <span class="keyword">import</span> distribute</span><br><span class="line"><span class="keyword">from</span> celery.schedules <span class="keyword">import</span> crontab</span><br><span class="line"></span><br><span class="line">app = distribute.app</span><br><span class="line">app.conf.update(</span><br><span class="line">    CELERYBEAT_SCHEDULE = &#123;</span><br><span class="line">        <span class="string">&#x27;every-minute&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;test_cron&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;schedule&#x27;</span>: crontab(minute=<span class="string">&quot;*&quot;</span>),</span><br><span class="line">            <span class="string">&#x27;args&#x27;</span>: (<span class="number">16</span>, <span class="number">13</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    CELERY_INCLUDE=(<span class="string">&quot;apps.tasks&quot;</span>,)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.start()</span><br></pre></td></tr></table></figure>

<p>实际工作单元,我放在 apps 目录下的 <code>tasks.py</code> 文件中</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lib.distribute <span class="keyword">import</span> app</span><br><span class="line"><span class="meta">@app.task(<span class="params">name=<span class="string">&quot;test_cron&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mul</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x * y</span><br></pre></td></tr></table></figure>

<p>上述是一个简单的 Crontab 应用，它仅需要以下命令就能执行,<br>其中  <code>--beat</code> 表示 crontab 的应用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python main.py worker --beat -l info</span><br></pre></td></tr></table></figure>

<p>起初我想把异步队列和定时任务放在一起,就加上了一句 CELERY_QUEUES 的配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">app.conf.update(</span><br><span class="line">    // 添加的部分</span><br><span class="line">    CELERY_QUEUES=(</span><br><span class="line">        Queue(</span><br><span class="line">          <span class="string">&#x27;test&#x27;</span>, Exchange(<span class="string">&#x27;test_exchange&#x27;</span>),</span><br><span class="line">           routing_key=<span class="string">&#x27;test_queue&#x27;</span></span><br><span class="line">        ),</span><br><span class="line">    ),</span><br><span class="line">    CELERYBEAT_SCHEDULE = &#123;</span><br><span class="line">        <span class="string">&#x27;every-minute&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;test_cron&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;schedule&#x27;</span>: crontab(minute=<span class="string">&quot;*&quot;</span>),</span><br><span class="line">            <span class="string">&#x27;args&#x27;</span>: (<span class="number">16</span>, <span class="number">13</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    CELERY_INCLUDE=(<span class="string">&quot;apps.tasks&quot;</span>,)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>同样用上述命令开启worker，发现这个时候 Crontab 不能工作了，后来看到官方的文档：</p>
<blockquote>
<p>celery beat and celery worker as separate services instead. </p>
</blockquote>
<p>也就是说 Celery 的 Beat 需要和其他异步worker 分开，单独执行。</p>
<p>相关代码<a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ToyCollection/tree/master/celery_proj">链接</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/07/23/2016-07-23-celeryde-crontabshi-jian/" data-id="clnfj8m21004t30qxfxh33vsv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-07-16-bash-jia-zai-shun-xu" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/16/2016-07-16-bash-jia-zai-shun-xu/" class="article-date">
  <time datetime="2016-07-16T03:35:00.000Z" itemprop="datePublished">2016-07-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/System/">System</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/16/2016-07-16-bash-jia-zai-shun-xu/">环境变量的那些事</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E8%8A%82">四种模式下的环境变量加载</a></li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E8%8A%82">跨机器SSH 传递环境变量</a></li>
</ul>
<h3 id="第一节">四种模式下的环境变量加载</h3>

<p>名词解析</p>
<ol>
<li>login shell: 指用户以非图形化界面 ssh登陆到机器上时获得的第一个 shell。 </li>
<li>interactive: 交互式，有输入提示符，它的标准输入输出和错误输出都会显示在控制台上。</li>
</ol>
<ul>
<li>interactive + login shell</li>
</ul>
<p>比如登陆机器后的第一个 shell 就是这种场景。它首先加载 &#x2F;etc&#x2F;profile，然后再依次去加载下列三个配置文件之一，一旦找到其中一个便不再接着寻找</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/.bash_profile</span><br><span class="line">~/.bash_login</span><br><span class="line">~/.profile</span><br></pre></td></tr></table></figure>

<p>设计如此多的配置是为了兼容 bourne shell 和 C shell，尽量杜绝使用 .bash_login，如果已创建，需要创建 .bash_profile 覆盖</p>
<ul>
<li>noninteractive + login shell</li>
</ul>
<p>bash -l script.sh 就是这种场景。<code>-l</code> 参数是将shell作为一个login shell启动，配置文件的加载与第一种完全一样。</p>
<ul>
<li>interactive + non-login shell</li>
</ul>
<p>在一个已有shell中运行bash，此时会打开一个交互式的shell，因为不再需要登陆，所以不是login shell。启动 shell 时会去查找并加载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/bash.bashrc</span><br><span class="line">~/.bashrc </span><br></pre></td></tr></table></figure>

<ul>
<li>non-interactive + non-login shell</li>
</ul>
<p>比如执行脚本 bash script.sh 或者 ssh user@remote command。这两种都是创建一个shell，执行完脚本之后便退出，不再需要与用户交互。它会去寻找环境变量BASH_ENV，将变量的值作为文件名进行查找，如果找到便加载它。</p>
<p>从网上看到一个清晰的图</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+----------------+--------+-----------+---------------+</span><br><span class="line">|                | login  |interactive|non-interactive|</span><br><span class="line">|                |        |non-login  |non-login      |</span><br><span class="line">+----------------+--------+-----------+---------------+</span><br><span class="line">|/etc/profile    |   A    |           |               |</span><br><span class="line">+----------------+--------+-----------+---------------+</span><br><span class="line">|/etc/bash.bashrc|        |    A      |               |</span><br><span class="line">+----------------+--------+-----------+---------------+</span><br><span class="line">|~/.bashrc       |        |    B      |               |</span><br><span class="line">+----------------+--------+-----------+---------------+</span><br><span class="line">|~/.bash_profile |   B1   |           |               |</span><br><span class="line">+----------------+--------+-----------+---------------+</span><br><span class="line">|~/.bash_login   |   B2   |           |               |</span><br><span class="line">+----------------+--------+-----------+---------------+</span><br><span class="line">|~/.profile      |   B3   |           |               |</span><br><span class="line">+----------------+--------+-----------+---------------+</span><br><span class="line">|BASH_ENV        |        |           |       A       |</span><br><span class="line">+----------------+--------+-----------+---------------+</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="第二节">跨机器传递环境变量</h3>

<p>假设要传递的变量叫做 $VARNAME</p>
<p>客户端机器的 <code>/etc/ssh_config</code> 添加 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SendEnv VARNAME</span><br></pre></td></tr></table></figure>

<p>服务端机器的 <code>/etc/sshd_config</code> 添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AcceptEnv VARNAME</span><br></pre></td></tr></table></figure>

<p>客户端机器的 $VARNAME 就可以通过 ssh 传递到服务端机器，继续使用.</p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="http://feihu.me/blog/2014/env-problem-when-ssh-executing-command-on-remote/">ssh连接远程主机执行脚本的环境变量问题</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/07/16/2016-07-16-bash-jia-zai-shun-xu/" data-id="clnfj8m21004r30qxftuq816k" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-06-03-zhun-que-jian-ce-mysql-fu-zhi-yan-chi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/03/2016-06-03-zhun-que-jian-ce-mysql-fu-zhi-yan-chi/" class="article-date">
  <time datetime="2016-06-03T15:35:00.000Z" itemprop="datePublished">2016-06-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/DataBase/">DataBase</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/03/2016-06-03-zhun-que-jian-ce-mysql-fu-zhi-yan-chi/">准确监控 MySQL 复制延迟</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>MySQL 建立主从复制后，在 <code>Slave_IO_Running</code>,<code>Slave_SQL_Runing</code> 都是 Yes 的前提下，通过监控 <code>Second_Behind_Master</code> 的数值来判断主从延迟时间，该值为0时是否意味着主从同步是无延迟的呢？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event</span><br><span class="line">....</span><br><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br><span class="line">Seconds_Behind_Master: <span class="number">0</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>很遗憾，我们并不能这样去判断，因为你看到的有可能是假象。</p>
<p>MySQL的同步是异步完成的，其中</p>
<ul>
<li>IO thread 接收从主库的 binlog，然后在从库生成 relay log</li>
<li>SQL thead 解析 relay log 后在从库上进行重放</li>
</ul>
<p><code>Second_Behind_Master</code>(以下简称SBM) 是 SQL thread 在执行IO thread 生成的relay log的时间差。relay log中event的时间戳是主库上的时间戳，而SQL thread的时间戳是从库上的，SBM 代表的是从库延后主库的时间差。</p>
<p>主库上执行了一个大的操作，这个操作在主库上没执行完毕的时候，从库的 SBM 会显示为0，而当主库执行完毕传到从库上开始执行的时候,SBM 就会显示很大，在网络状况不好的情况下，更是容易出现 SBM 在零和一个巨大的数值反复飘忽的现象。</p>
<h3 id="pt-heartbeat-帮我们准确地检测"><a href="#pt-heartbeat-帮我们准确地检测" class="headerlink" title="pt-heartbeat 帮我们准确地检测"></a>pt-heartbeat 帮我们准确地检测</h3><p>pt-heartbeat 是 percona-toolkit 中用来检测主从延迟的工具，需要在主库和从库同时配合才能完成</p>
<ul>
<li>首先在主库创建监控的表，并定时更新</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//创建 heartbeat 表</span><br><span class="line">pt-heartbeat --user=root --ask-pass \</span><br><span class="line">            --host=localhost -D &lt;YourDatabase&gt; \</span><br><span class="line">            --create-table --update </span><br><span class="line"></span><br><span class="line">//每隔60s,定时更新状态，以守护进程的方式执行</span><br><span class="line">pt-heartbeat --user=root --ask-pass \</span><br><span class="line">           --host=localhost -D &lt;YourDatabase&gt;\</span><br><span class="line">           --interval=60 --update --replace --daemonize</span><br></pre></td></tr></table></figure>
<p>它会在指定的数据库里生产一张名为 heartbeat 的表，每隔60秒定时更新binlog 文件和位置，以及时间戳。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------+-----------+------------------+-----------+-----------------------+---------------------+</span><br><span class="line">| ts                         | server_id | file             | position  | relay_master_log_file | exec_master_log_pos |</span><br><span class="line">+----------------------------+-----------+------------------+-----------+-----------------------+---------------------+</span><br><span class="line">| 2016-06-03T22:26:29.000720 |         6 | mysql-bin.004| 716| mysql-bin.002|           291330290 |</span><br><span class="line">+----------------------------+-----------+------------------+-----------+-----------------------+---------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li>接着在从库以守护进程执行定期检测,并将结果重定向到文本</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pt-heartbeat --user=root --ask-pass \</span><br><span class="line">     --host=localhost -D &lt;YourDatabase&gt; --interval=60 \</span><br><span class="line">     --file=/tmp/output.txt --monitor --daemonize</span><br></pre></td></tr></table></figure>

<p>文本的内容只有一行，每隔指定的时间就会被覆盖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">29.00s [ 30.20s,  6.04s,  2.01s ]</span><br></pre></td></tr></table></figure>

<p>29s 表示的是瞬间的延迟时间，30.20s 表示1分钟的延迟时间，6.04秒表示5分钟的延迟时间，2.01秒表示以及15分钟的延迟时间，在主从机器时间校准的前提下，这个数据才是客观准确的主从延迟。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/06/03/2016-06-03-zhun-que-jian-ce-mysql-fu-zhi-yan-chi/" data-id="clnfj8m20004p30qxgz6tho6s" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-04-24-ansible-dynamic-inventory" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/24/2016-04-24-ansible-dynamic-inventory/" class="article-date">
  <time datetime="2016-04-24T12:53:00.000Z" itemprop="datePublished">2016-04-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/System/">System</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/24/2016-04-24-ansible-dynamic-inventory/">Ansible Dynamic Inventory</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Ansible 在使用的过程中，如果机器数量比较固定，且变更不多的情况下，可在 &#x2F;etc&#x2F;ansible&#x2F;hosts 文件里面配置固定的组合机器IP， 并给他起组的别名，执行 Ansible 脚本便可以通过别名找到相应的机器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">111.222.333.444 ansible_ssh_port=888</span><br></pre></td></tr></table></figure>

<p>假如你有很多台机器，且机器经常变更导致IP时常变换，你还想把IP逐个写入 &#x2F;etc&#x2F;ansible&#x2F;hosts 就不现实了。你也许会问，若不把 IP 写进 &#x2F;etc&#x2F;ansible&#x2F;hosts，那不是没法用 Ansible 指挥这些机器？<br>感谢 Ansible Dynamic Inventory， 如果我们能通过编程等手段获取变更机器的IP，我们还是有办法实现的。</p>
<h3 id="Dynamic-Inventory-的原理"><a href="#Dynamic-Inventory-的原理" class="headerlink" title="Dynamic Inventory 的原理"></a>Dynamic Inventory 的原理</h3><ul>
<li>通过编程的方式,也就是动态获取机器的 json 信息;</li>
<li>Ansible 通过解析这串 json 字符串;</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i yourprogram.py -m raw  -a &#x27;cd /home&#x27;</span><br></pre></td></tr></table></figure>

<p>Ansible Dynamic Inventory 对程序返回的 json 的转义是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;devtest-asg&quot;: &#123;&quot;hosts&quot;: [&quot;172.31.21.164&quot;], &quot;vars&quot;: &#123;&quot;ansible_ssh_port&quot;: 12306&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>翻译一下就是  &#x2F;etc&#x2F;ansible&#x2F;hosts 中的:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[devtest-asg]</span><br><span class="line">172.31.21.164 ansible_ssh_port=12306</span><br></pre></td></tr></table></figure>

<h3 id="一个实战的例子"><a href="#一个实战的例子" class="headerlink" title="一个实战的例子"></a>一个实战的例子</h3><p>官方文档对 Inventory 仅作概念性描述，阅读完后仍是一头雾水，不知如何下手。 让我们用一个例子来豁然开朗吧。 我们使用 AWS 的 AutoScaling Group，以下简称 ASG，ASG 会在某种自定义的条件下会自动开启和关闭机器，这给我们在辨别IP，定位机器的时候造成困扰。因此我们需要 Ansible Dynamic Inventory</p>
<p>我们使用 AWS 的 boto 库来获取 ASG 的实例信息.以下程序(get_host.py)中要实现的方法就是列出返回机器信息的 json 串。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> boto</span><br><span class="line"><span class="keyword">import</span> boto.ec2</span><br><span class="line"><span class="keyword">import</span> boto.ec2.autoscale</span><br><span class="line"></span><br><span class="line">AWS_REGION = <span class="string">&#x27;BBB&#x27;</span></span><br><span class="line">AWS_ACCESS_KEY = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line">AWS_SECRET_KEY = <span class="string">&#x27;yyy&#x27;</span></span><br><span class="line"></span><br><span class="line">result = &#123;&#125;</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getData</span>():</span><br><span class="line">    conn_as = boto.ec2.autoscale.connect_to_region(</span><br><span class="line">            <span class="string">&#x27;cn-north-1&#x27;</span>,</span><br><span class="line">            aws_access_key_id=AWS_ACCESS_KEY,</span><br><span class="line">            aws_secret_access_key=AWS_SECRET_KEY)</span><br><span class="line">    group = conn_as.get_all_groups(names=[<span class="string">&#x27;devtest-asg&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">    conn_ec2 = boto.ec2.connect_to_region(</span><br><span class="line">            AWS_REGION,</span><br><span class="line">            aws_access_key_id=AWS_ACCESS_KEY,</span><br><span class="line">            aws_secret_access_key=AWS_SECRET_KEY)</span><br><span class="line"></span><br><span class="line">    instance_ids = [i.instance_id <span class="keyword">for</span> i <span class="keyword">in</span> group.instances]</span><br><span class="line">    reservations = conn_ec2.get_all_instances(instance_ids)</span><br><span class="line">    instances = [i <span class="keyword">for</span> r <span class="keyword">in</span> reservations <span class="keyword">for</span> i <span class="keyword">in</span> r.instances]</span><br><span class="line"></span><br><span class="line">    result[<span class="string">&#x27;devtest-asg&#x27;</span>] = &#123;&#125;</span><br><span class="line">    result[<span class="string">&#x27;devtest-asg&#x27;</span>][<span class="string">&#x27;hosts&#x27;</span>] = []</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> reservations:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> r.instances:</span><br><span class="line">            result[<span class="string">&#x27;devtest-asg&#x27;</span>][<span class="string">&#x27;hosts&#x27;</span>].append(<span class="string">&#x27;%s&#x27;</span> % i.private_ip_address)</span><br><span class="line">            result[<span class="string">&#x27;devtest-asg&#x27;</span>][<span class="string">&#x27;vars&#x27;</span>] = &#123;<span class="string">&#x27;ansible_ssh_port&#x27;</span>: <span class="number">36000</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getlists</span>():</span><br><span class="line">    getData()</span><br><span class="line">    <span class="built_in">print</span> json.dumps(result)</span><br><span class="line"></span><br><span class="line">getlists()</span><br></pre></td></tr></table></figure>

<p>执行以下命令就可以愉快地使用 Ansible 了，其中 devtest-asg 是 ASG 的别名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible -i get_host.py  devtest-asg -m raw -a &#x27;ls /&#x27;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/24/2016-04-24-ansible-dynamic-inventory/" data-id="clnfj8m20004n30qxh856170o" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-04-23-flume-shi-shi-shou-ji-nginx-ri-zhi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/23/2016-04-23-flume-shi-shi-shou-ji-nginx-ri-zhi/" class="article-date">
  <time datetime="2016-04-23T01:13:00.000Z" itemprop="datePublished">2016-04-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/System/">System</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/23/2016-04-23-flume-shi-shi-shou-ji-nginx-ri-zhi/">Flume 实时收集 Nginx 日志</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在分布式系统中，各个机器都有程序运行的本地日志，有时为了分析需求，不得不这些分散的日志汇总需求，相信很多人会选择 Rsync，Scp 之类，<br>但它们的实时性不强，而且也会带来名字冲突的问题。扩展性差强人意，一点也不优雅。</p>
<p>现实中，我们就碰到了这样的需求：实时汇总线上多台服务器的 Nginx 日志。Flume 立功了。</p>
<h1 id="Flume-简介"><a href="#Flume-简介" class="headerlink" title="Flume 简介"></a>Flume 简介</h1><p><a target="_blank" rel="noopener" href="https://flume.apache.org/"><strong>F</strong>lume</a> 是一个分布式，可靠高效的日志收集系统，它允许用户自定义数据传输模型，因此可扩展性也强。也有较强的容错和恢复机制.<br>以下是几个重要的概念</p>
<ul>
<li>Event：Event 是 Flume 数据传输的基本单元。flume 以事件的形式将数据从源头传送到最终的目的。</li>
<li>Agent：Agent包含 Sources, Channels, Sinks 和其他组件，它利用这些组件将events从一个节点传输到另一个节点或最终目的。</li>
<li>Source：Source负责接收events，并将events批量的放到一个或多个Channels。</li>
<li>Channel：Channel位于 Source 和 Sink 之间，用于缓存进来的events，当Sink成功的将events发送到下一跳的channel或最终目的，events从Channel移除。</li>
<li>Sink：Sink 负责将 events 传输到下一跳或最终目的，成功完成后将events从channel移除。</li>
</ul>
<img src="/images/2016/04/flume.jpg" class="">


<ul>
<li>Source 就有 Syslog Source, Kafka Source,HTTP Source, Exec Source Avro Source 等。</li>
<li>Sink 有 Kafka Sink, Avro Sink, File Roll Sink, HDFS Sink 等。</li>
<li>Channel 有 Memory Channel,File Channel 等</li>
</ul>
<p>它提供了一个骨架，以及多种 Source, Sink, Channel, 让你设计合适的数据模型。事实上也可以多个 Flume 联动完成，就像地铁的车厢一样。</p>
<h1 id="定义数据流模型"><a href="#定义数据流模型" class="headerlink" title="定义数据流模型"></a>定义数据流模型</h1><p>回到我们开头的场景,我们要将多台服务器的 Nginx 日志进行汇总分析，</p>
<p>分成两个 flume 来实现</p>
<ul>
<li>Flume1 数据流是 Exec Source -&gt; Memory Channel -&gt; Avro Sink,部署在业务机器上</li>
<li>Flume2 数据流是 Avro Source -&gt; Memory Channel -&gt; FileRoll Sink</li>
</ul>
<img src="/images/2016/04/flume1toflume2.jpg" class="">

<h1 id="需要的准备"><a href="#需要的准备" class="headerlink" title="需要的准备"></a>需要的准备</h1><p>你需要安装</p>
<ul>
<li>下载 <a target="_blank" rel="noopener" href="https://flume.apache.org/download.html">Flume</a></li>
<li>安装 JavaSDk,并在下载解压之后的 conf&#x2F;flume-env.sh，配置</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 我用的是oracle-java-8</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/lib/jvm/java-8-oracle/jre/</span><br></pre></td></tr></table></figure>
<ul>
<li>思考你的数据流动模型，编写配置，如上文所说的Flume1, tail2avro.conf  ：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">agent.sources = s1</span><br><span class="line">agent.channels = c1</span><br><span class="line">agent.sinks = k1</span><br><span class="line"></span><br><span class="line">agent.sources.s1.type=exec</span><br><span class="line">agent.sources.s1.command=tail -F &lt;Your File Path&gt;</span><br><span class="line">agent.sources.s1.channels=c1</span><br><span class="line"></span><br><span class="line">agent.channels.c1.type=memory</span><br><span class="line">agent.channels.c1.capacity=10000</span><br><span class="line">agent.channels.c1.transactionCapacity=10000</span><br><span class="line"></span><br><span class="line">agent.sinks.k1.type = avro</span><br><span class="line">agent.sinks.k1.hostname = &lt;Your Target Address&gt;</span><br><span class="line">agent.sinks.k1.port = &lt;Your Target Port&gt;</span><br><span class="line">agent.sinks.k1.channel=c1</span><br></pre></td></tr></table></figure>

<p>Flume2 中的 avro2file.conf </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">agent.sources = s1</span><br><span class="line">agent.channels = c1</span><br><span class="line">agent.sinks = k1</span><br><span class="line"></span><br><span class="line">agent.sources.s1.type = avro</span><br><span class="line">agent.sources.s1.bind = &lt;Your Address&gt;</span><br><span class="line">agent.sources.s1.port = &lt;Your Port&gt;</span><br><span class="line">agent.sources.s1.channels = c1</span><br><span class="line"></span><br><span class="line">agent.sinks.k1.type = file_roll</span><br><span class="line">agent.sinks.k1.sink.directory = /data/log/ngxlog</span><br><span class="line"># 滚动间隔</span><br><span class="line">agent.sinks.k1.sink.rollInterval = 86400</span><br><span class="line">agent.sinks.k1.channel = c1</span><br><span class="line"></span><br><span class="line">agent.channels.c1.type = memory</span><br><span class="line"># 队列里 Event 的容量</span><br><span class="line">agent.channels.c1.capacity = 10000</span><br><span class="line">agent.channels.c1.transactionCapacity = 10000</span><br><span class="line">agent.channels.c1.keep-alive = 60</span><br></pre></td></tr></table></figure>

<ul>
<li>启动运行</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 启动flume1</span><br><span class="line">bin/flume-ng agent -n agent -c conf -f conf/tail2avro.conf \</span><br><span class="line">-Dflume.root.logger=WARN</span><br><span class="line"></span><br><span class="line"># 启动flume2</span><br><span class="line">in/flume-ng agent -n agent -c conf -f conf/avro2file.conf \</span><br><span class="line">-Dflume.root.logger=INFO</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://flume.apache.org/FlumeUserGuide.html">FlumeUserGuide</a> 官方的 FlumeUserGuide</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/23/2016-04-23-flume-shi-shi-shou-ji-nginx-ri-zhi/" data-id="clnfj8m1z004k30qxam9wb8dj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2016-03-10-gai-xuan-ze-na-chong-redischi-jiu-hua-pei-zhi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/03/10/2016-03-10-gai-xuan-ze-na-chong-redischi-jiu-hua-pei-zhi/" class="article-date">
  <time datetime="2016-03-10T15:32:00.000Z" itemprop="datePublished">2016-03-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Redis/">Redis</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/10/2016-03-10-gai-xuan-ze-na-chong-redischi-jiu-hua-pei-zhi/">Redis 该选择哪种持久化配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这个标题或许会让你想起<a target="_blank" rel="noopener" href="https://movie.douban.com/subject/1291843/">《黑客帝国》</a>里经典的台词，你要选择蓝色药丸，还是红色药丸？</p>
<p>Redis 是我们重度使用的一个开源软件，对它的持久化配置做一番相对深入的总结，是值得的。目前它有两种主流的持久化存储方式 SnapShot 以及 AOF 。</p>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E8%8A%82">什么是 Snapshot</a></li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E8%8A%82">什么是 AOF </a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E8%8A%82">选择哪种药丸</a></li>
</ul>
<h3 id="第一节">什么是 Snapshot</h3>

<p>Snapshot 将内存中数据以结构化的方式序列化到 rdb 文件中，是默认的持久化方式，便于解析引擎快速解析和内存实施。快照得由间隔时间，变更次数同时符合才会触发， 该过程中并不阻塞客户端请求，copy-on-write 方式也意味着极端情况下可能会导致实际数据2倍内存的使用量。它首先将数据写入临时文件，结束后，将临时文件重名为 dump.rdb。可以使用 <code>redis-check-dump</code> 用来检测完整性</p>
<p>只有快照结束后才会将旧的文件替换成新的，因此任何时候 RDB 文件都是完整的。如果在触发 snapshot 之前，server 失效。会导致上一个时间点之后的数据未能序列化到 rdb 文件，安全性上稍弱。 </p>
<p>我们可手动执行 save 或 bgsave 命令让 redis 执行快照。两个命令的区别在于:</p>
<ul>
<li>save 是由主进程进行快照操作，会阻塞其它请求;</li>
<li>bgsave 会通过 fork 子进程进行快照操作;</li>
</ul>
<p>RDB 文件默认是经过压缩的二进制文件，占用的空间会小于内存中的数据，更加利于传输。设置如下，可以关闭快照功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save &quot;&quot;</span><br></pre></td></tr></table></figure>


<h4 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># snapshot触发的时机，save &lt;seconds&gt; &lt;changes&gt;， 比如600秒有2个操作</span><br><span class="line">save 600 2</span><br><span class="line"># 当snapshot 时出现错误无法继续时，是否阻塞客户端变更操作 </span><br><span class="line">stop-writes-on-bgsave-error yes </span><br><span class="line"># 是否启用rdb文件压缩，默认为 yes cpu消耗，快速传输  </span><br><span class="line">rdbcompression yes  </span><br><span class="line"># rdb文件名称  </span><br><span class="line">dbfilename dump.rdb  </span><br></pre></td></tr></table></figure>


<h3 id="第二节">什么是 AOF</h3>

<p>Append-only file，将 <code>操作 + 数据</code> 以格式化指令的方式追加到操作日志文件的尾部，在 append 操作返回后， 已经写入到文件或者即将写入，才进行实际的数据变更，日志文件保存了历史的操作过程；当 server 需要数据恢复时，可以直接回放此日志文件，即可还原所有的操作过程。 如果你期望数据更少的丢失，那么可以采用 AOF 模式。可以用 redis-check-aof 检测文件是否完整。</p>
<p>AOF 就是日志会记录变更操(例如：set&#x2F;del等)，会导致AOF文件非常的庞大，意味着server失效后，数据恢复的过程将会很长；事实上，一条数据经过多次变更，将会产生多条AOF记录，其实只要保存当前的状态，历史的操作记录是可以抛弃的， 由此催生了 AOF ReWrite。</p>
<h4 id="什么是-AOF-Rewrite"><a href="#什么是-AOF-Rewrite" class="headerlink" title="什么是 AOF Rewrite"></a>什么是 AOF Rewrite</h4><p>其实是压缩 AOF 文件的过程，Redis 采取了类似 Snapshot 的方式：基于 <code>copy-on-write</code>，全量遍历内存中数据，然后逐个序列到 aof 文件中。因此 AOF Rewrite 能够正确反应当前内存数据的状态， Rewrite 过程中，新的变更操作将仍然被写入到原 AOF 文件中，同时这些新的变更操作也会被收集起来， 并不阻塞客户端请求。</p>
<h4 id="相关配置-1"><a href="#相关配置-1" class="headerlink" title="相关配置"></a>相关配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">##只有在yes下，aof重写/文件同步等特性才会生效  </span><br><span class="line">appendonly no  </span><br><span class="line">  </span><br><span class="line">##指定aof文件名称  </span><br><span class="line">appendfilename appendonly.aof  </span><br><span class="line">  </span><br><span class="line">##指定aof操作中文件同步策略，有三个合法值：always everysec no，默认为everysec  </span><br><span class="line">appendfsync everysec  </span><br><span class="line"></span><br><span class="line">##在aof-rewrite期间，appendfsync 是否暂缓文件同步，no 表示不暂缓，yes 表示暂缓，默认为no  </span><br><span class="line">no-appendfsync-on-rewrite no  </span><br><span class="line">  </span><br><span class="line">##aof文件rewrite触发的最小文件尺寸 只有大于此aof文件大于此尺寸是才会触发rewrite，默认64mb，建议512mb  </span><br><span class="line">auto-aof-rewrite-min-size 64mb  </span><br><span class="line">  </span><br><span class="line">##相对于上一次rewrite，本次rewrite触发时aof文件应该增长的百分比</span><br><span class="line">auto-aof-rewrite-percentage 100  </span><br></pre></td></tr></table></figure>

<h4 id="appendfsync-方式："><a href="#appendfsync-方式：" class="headerlink" title="appendfsync 方式："></a>appendfsync 方式：</h4><ul>
<li>always：每一条 aof 记录都立即同步到文件，这是最安全的方式，但是更多的磁盘操作和阻塞延迟，IO 开支较大。</li>
<li>everysec：每秒同步一次，性能和安全也是redis推荐的方式。如果服务器故障，有可能导致最近一秒内aof记录丢失。</li>
<li>no：redis并不直接调用文件同步，而是交给操作系统来处理，操作系统可以根据buffer填充情况等择机触发同步；性能较好，在物理服务器故障时，数据丢失量会因OS配置有关。</li>
</ul>
<h3 id="第三节">选择哪种药丸</h3>

<ul>
<li>AOF更安全，可将数据及时同步到文件中，但需要较多的磁盘IO，AOF文件尺寸较大，文件内容恢复相对较慢， 也更完整。</li>
<li>Snapshot，安全性较差，它是正常时期数据备份及 master-slave 数据同步的最佳手段，文件尺寸较小，恢复数度较快。</li>
</ul>
<h4 id="主从架构的环境下的选择"><a href="#主从架构的环境下的选择" class="headerlink" title="主从架构的环境下的选择"></a>主从架构的环境下的选择</h4><ul>
<li>通常 master 使用AOF，slave 使用 Snapshot，master 需要确保数据完整性，slave 提供只读服务.</li>
<li>如果你的网络稳定性差， 物理环境糟糕情况下，那么 master， slave均采取 AOF，这个在 master， slave角色切换时，可以减少时间成本；</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/03/10/2016-03-10-gai-xuan-ze-na-chong-redischi-jiu-hua-pei-zhi/" data-id="clnfj8m1z004i30qx9svfgjqz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-01-07-shi-shi-jian-kong-nginx-qps-de-tuo-zhan" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/07/2016-01-07-shi-shi-jian-kong-nginx-qps-de-tuo-zhan/" class="article-date">
  <time datetime="2016-01-07T04:59:00.000Z" itemprop="datePublished">2016-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/System/">System</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/07/2016-01-07-shi-shi-jian-kong-nginx-qps-de-tuo-zhan/"> 实时监控 nginx qps 的拓展</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>用下班时间写了一个 ngx lua 的拓展, <a target="_blank" rel="noopener" href="https://github.com/zheng-ji/ngx_lua_reqstatus">GitHub</a>。可以:</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 实时监控域名的 qps</li>
<li><input checked="" disabled="" type="checkbox"> 实时监控域名的 5xx 个数</li>
<li><input checked="" disabled="" type="checkbox"> 实时监控域名的 响应时长</li>
<li><input checked="" disabled="" type="checkbox"> 并附带 Ganglia 监控插件</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ul>
<li>配置 <code>nginx.conf</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    lua_shared_dict statics_dict    1M; # 初始化变量</span><br><span class="line">    lua_package_path &quot;/etc/nginx/ngx_lua_reqstatus/?.lua&quot;;  #路径</span><br><span class="line">    log_by_lua_file &quot;/etc/nginx/ngx_lua_reqstatus/hook.lua&quot;; # 添加此句</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name  justforfun.com; </span><br><span class="line"></span><br><span class="line">        location /&#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    # 监控服务</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 127.0.0.1:6080;</span><br><span class="line">        location /&#123;</span><br><span class="line">            access_by_lua_file &quot;/etc/nginx/ngx_lua_reqstatus/status.lua&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>效果</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:6080/?domain=justforfun.com</span><br></pre></td></tr></table></figure>

<ul>
<li>输出</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Server Name:    justforfun.com</span><br><span class="line">Seconds SinceLast:   1.4399998188019 secs</span><br><span class="line">Request Count:      1</span><br><span class="line">Average Req Time:   0 secs</span><br><span class="line">Requests Per Secs:  0.69444453182781</span><br><span class="line">5xx num:    0</span><br></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/01/07/2016-01-07-shi-shi-jian-kong-nginx-qps-de-tuo-zhan/" data-id="clnfj8m1y004g30qx7sora12l" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-12-10-fen-xi-nginxri-zhi-de-li-qi-goaccess" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/10/2015-12-10-fen-xi-nginxri-zhi-de-li-qi-goaccess/" class="article-date">
  <time datetime="2015-12-10T15:28:00.000Z" itemprop="datePublished">2015-12-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/System/">System</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/10/2015-12-10-fen-xi-nginxri-zhi-de-li-qi-goaccess/">Nginx 日志利器 GoAccess</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>我们经常需要从 Nginx 日志分析得出很多有价值的东西，分析的方法是各种 shell, awk, python, 现在 <a target="_blank" rel="noopener" href="https://github.com/allinurl/goaccess">GoAccess</a> 给你另外一种选择, 值得拥有。</p>
<ul>
<li>安装<br>用以下的方式安装，才能得到新版的 GoAccess, 功能更健全</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;deb http://deb.goaccess.io $(lsb_release -cs) main&quot;|sudo tee -a /etc/apt/sources.list</span><br><span class="line">$ wget -O - http://deb.goaccess.io/gnugpg.key | sudo apt-key add -</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install goaccess</span><br></pre></td></tr></table></figure>
<ul>
<li>推荐配置</li>
</ul>
<p>安装完成之后，会生成一份 <code>/etc/goaccess.conf</code> 稍作编辑，这就是默认的配置，免去了后续每次都要定义格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">time-format %T   # 只有这种方式才能解决 0.0us 的显示问题</span><br><span class="line">date-format %d/%b/%Y</span><br><span class="line">log-format %h %^[%d:%t %^] &quot;%r&quot; %s %b &quot;%R&quot; &quot;%u&quot; %T</span><br></pre></td></tr></table></figure>
<ul>
<li>使用</li>
</ul>
<p>输出报表，报表中，我们可以看到最常访问的 IP, 接口，以及每个接口使用带宽，平均响应时长，状态码等，对业务分析有较好的便利性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">终端显示</span><br><span class="line">goaccess -f access.log </span><br><span class="line"> </span><br><span class="line">输出报表，报表中，我们可以看到top ip, 接口，以及接口使用带宽，平均响应时长，状态码等</span><br><span class="line">goaccess -f access.log &gt; report.html</span><br><span class="line"> </span><br><span class="line">具体某段时间的输出</span><br><span class="line">sed -n &#x27;/5\/Dec\/2015/,/10\/Dec\/2010/ p&#x27; access.log | goaccess -a</span><br><span class="line"> </span><br><span class="line">处理已经压缩的日志</span><br><span class="line">zcat access.log.*.gz | goaccess</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/10/2015-12-10-fen-xi-nginxri-zhi-de-li-qi-goaccess/" data-id="clnfj8m1y004e30qx8zs03fa0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-12-05-gre-tuning-and-keepalived" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/05/2015-12-05-gre-tuning-and-keepalived/" class="article-date">
  <time datetime="2015-12-05T02:29:00.000Z" itemprop="datePublished">2015-12-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/System/">System</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/05/2015-12-05-gre-tuning-and-keepalived/">Gre 隧道与 Keepalived</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这一篇文章是做了不少功课的。</p>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E8%8A%82">什么是 Gre 隧道</a></li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E8%8A%82">什么是 Vrrp </a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E8%8A%82">KeepAlived 是什么</a></li>
<li><a href="#%E7%AC%AC%E5%9B%9B%E8%8A%82">用Keepalived 怎么玩</a></li>
<li><a href="#%E7%AC%AC%E4%BA%94%E8%8A%82">附录</a></li>
</ul>
<h3 id="第一节">什么是 Gre 隧道 </h3>

<p>GRE 隧道是一种 IP-2-IP 的隧道，是通用路由封装协议，可以对某些网路层协议的数据报进行封装，使这些被封装的数据报能够在 IPv4&#x2F;IPv6 网络中传输。Tunnel 是一个虚拟的点对点的连接，提供了一条通路使封装的数据报文能够在这个通路上传输，并且在一个Tunnel 的两端分别对数据报进行封装及解封装。Linux 上创建 GRE 隧道，需要 ip_gre 内核模块，它是Pv4 隧道的驱动程序。</p>
<p>假设我有2台服务器，想做这两台之间创建 GRE 隧道</p>
<ul>
<li>$server_A_ip 表示服务器A的IP</li>
<li>$server_B_ip 服务器B 的内网IP</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 在 A 机器上执行</span><br><span class="line"># 创建 GRE 协议的 虚拟网络设备, 指定本地和对端 IP</span><br><span class="line">sudo ip link add gretap1 type gretap local $server_a_ip remote $server_b_ip </span><br><span class="line">sudo ip link set dev gretap1 up  # 启动该设备</span><br><span class="line">sudo ip addr add dev gretap1 10.1.1.2/24 # 给该设备一个虚拟网络地址</span><br><span class="line"></span><br><span class="line"># 在 B 机器上执行</span><br><span class="line"># 创建 GRE 协议的 虚拟网络设备, 指定本地和对端 IP</span><br><span class="line">sudo ip link add gretap1 type gretap local $server_b_ip remote $server_a_ip </span><br><span class="line">sudo ip link set dev gretap1 up  # 启动该设备</span><br><span class="line">sudo ip addr add dev gretap1 10.1.1.3/24 # 给该设备一个虚拟网络地址</span><br></pre></td></tr></table></figure>

<p>如果想停止或者删除上述网卡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip link set gretap1 down</span><br><span class="line">ip tunnel del gretap1</span><br></pre></td></tr></table></figure>

<p>至此点到点得隧道建立。</p>
<h3 id="第二节">什么是 vrrp 协议 </h3>

<p>VRRP(Virtual Router Redundancy Protocol), 即虚拟路由冗余协议。是实现路由器高可用的容错协议。</p>
<p>即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个 master 和多个 backup， 但在外界看来就像一台一样，构成虚拟路由器，拥有一个虚拟IP（vip），占有这个IP 的 master 实际负责 ARP 相应和转发 IP 数据包， 组中的其它路由器作为备份的角色处于待命状态。 master 会发组播消息，当 backup 在超时时间内收不到 vrrp 包时就认为 master 宕掉了，这时就需要根据VRRP的优先级来选举一个backup当master，保证路由器的高可用。</p>
<h3 id="第三节"> Keepalived 是什么 </h3>

<p>Keepalived 是一个基于 VRRP 协议来实现的服务高可用方案，可以利用其来避免IP单点故障。</p>
<ul>
<li>一个经典的案例</li>
</ul>
<p>一个WEB服务至少会有2台服务器运行 Keepalived，一台为主服务器，一台为备份服务器, 但是对外表现为一个虚拟IP，主服务器会发送特定的消息给备份服务器，当备份服务器收不到这个消息的时候，即主服务器宕机的时候，备份服务器就会接管虚拟IP，继续提供服务，从而保证了高可用性。</p>
<h3 id="第四节">怎么玩 Keepalived</h3>

<ul>
<li>安装</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install keepalived</span><br></pre></td></tr></table></figure>

<p>之前提到的，我们在 A, B 两台服务器建立起了 GRE 隧道了。 现在我们有一个虚拟的内网IP， 姑且叫做 $virtual_third_ip<br>接着在 A 服务器上</p>
<ul>
<li>配置</li>
</ul>
<p>编辑服务器 A, B 的 <code>/etc/keepalived/keepalived.conf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface gretap1 # 绑在建立起来的隧道上</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    # 优先级别,越高的设备会被弄成主设备, A,B 服务器要有所差别，其他都一样</span><br><span class="line">    priority 100          advert_int 1      # 广播时间间隔</span><br><span class="line">    authentication &#123;  #  验证相关</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        $virtual_third_ip dev eth0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们将服务器  A 作为 Master, 服务器 B 当做 Backup, 当服务器 A 需要停机的时候，$virtual_third_ip 就会漂移到服务器 B 上面。 我们两台机器都有相同配置的 Nginx 服务，就可以保障机器出现故障的时候，Nginx 服务丝毫不受影响。</p>
<h3 id="第五节"> 附录 </h3>

<ul>
<li><a target="_blank" rel="noopener" href="http://linux.vbird.org/linux_server/0140networkcommand.php">鸟哥的网络知识</a></li>
<li><a target="_blank" rel="noopener" href="http://www.tldp.org/HOWTO/Adv-Routing-HOWTO/lartc.tunnel.gre.html">GRE tuneling</a></li>
<li><a target="_blank" rel="noopener" href="http://baike.baidu.com/link?url=N1-VGuzQC0PJ2bCnOzYn-XRTlN8eFGCvIJQlTI6KDL5Fx3EQxoRGTrxazb11jfZQqlfeA6q2Ka0VKRVEc0Kdu3GEyhqe1W_Ae2h0Tqu5NacIjOSaSnUVeOe-9QV5dB8q0Wv_uq8-vqdnQICt39UZFK">VRRP</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/05/2015-12-05-gre-tuning-and-keepalived/" data-id="clnfj8m1y004c30qx8deq1rsd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/6/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/DataBase/">DataBase</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/ElasticSearch/">ElasticSearch</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Life/">Life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/NLP/">NLP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/NetWork/">NetWork</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Product/">Product</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Program/">Program</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Server/">Server</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/">System</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/grpc/">grpc</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/k8s/">k8s</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mq/">mq</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithm/" rel="tag">Algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-11/" rel="tag">C++11</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DataBase/" rel="tag">DataBase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/" rel="tag">Go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LRU/" rel="tag">LRU</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MQ/" rel="tag">MQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ProtoBuffer/" rel="tag">ProtoBuffer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/System/" rel="tag">System</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/groupCache/" rel="tag">groupCache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grpc/" rel="tag">grpc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s-basic/" rel="tag">k8s basic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx-grpc/" rel="tag">nginx grpc</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Algorithm/" style="font-size: 10px;">Algorithm</a> <a href="/tags/C-11/" style="font-size: 10px;">C++11</a> <a href="/tags/DataBase/" style="font-size: 10px;">DataBase</a> <a href="/tags/Go/" style="font-size: 10px;">Go</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/LRU/" style="font-size: 10px;">LRU</a> <a href="/tags/MQ/" style="font-size: 10px;">MQ</a> <a href="/tags/ProtoBuffer/" style="font-size: 10px;">ProtoBuffer</a> <a href="/tags/Redis/" style="font-size: 16.67px;">Redis</a> <a href="/tags/System/" style="font-size: 10px;">System</a> <a href="/tags/groupCache/" style="font-size: 10px;">groupCache</a> <a href="/tags/grpc/" style="font-size: 13.33px;">grpc</a> <a href="/tags/k8s/" style="font-size: 20px;">k8s</a> <a href="/tags/k8s-basic/" style="font-size: 10px;">k8s basic</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nginx-grpc/" style="font-size: 10px;">nginx grpc</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">May 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/05/">May 2012</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03/">March 2012</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/20/2021-10-20-why-docker-supervisor/"> Docker里使用 supervisor 管理多个程序</a>
          </li>
        
          <li>
            <a href="/2021/10/14/2021-10-14-binary-tree-algo/">二叉树相关的递归算法题</a>
          </li>
        
          <li>
            <a href="/2021/10/13/2021-10-13-go-channel/">Go Channel 笔记</a>
          </li>
        
          <li>
            <a href="/2021/10/12/2021-10-12-why-kafka-so-fast/">Kafka 吞吐量大的原因</a>
          </li>
        
          <li>
            <a href="/2021/10/11/2021-10-11-redis-pipeline/">Redis Pipline 与事务</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 zheng-ji<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>